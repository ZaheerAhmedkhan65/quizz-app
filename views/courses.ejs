<%- include('partials/_header') %>

<div class="row">
  <div class="col-md-6">
    <h2>Courses</h2>
  </div>
</div>

<!-- Spinner -->
<div id="loadingSpinner" class="text-center my-5">
  <div class="spinner-border text-primary" role="status">
    <span class="sr-only"></span>
  </div>
</div>

<!-- Table (hidden initially) -->
<div id="coursesTableWrapper" class="table-responsive" style="display: none;">
  <table class="table table-hover table-bordered align-middle">
    <thead>
      <tr>
        <th scope="col">Course</th>
        <th scope="col">Enroll</th>
      </tr>
    </thead>
    <tbody id="coursesContainer">
      <!-- Courses will be loaded here dynamically -->
    </tbody>
  </table>
</div>

<!-- No Courses Message -->
<div id="noCoursesMessage" class="alert alert-warning text-center" style="display: none;">
  No courses found matching your criteria.
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    fetchCourses();
  });

  function fetchCourses(searchTerm = '') {
    const container = document.getElementById('coursesContainer');
    const spinner = document.getElementById('loadingSpinner');
    const noCoursesMsg = document.getElementById('noCoursesMessage');
    const tableWrapper = document.getElementById('coursesTableWrapper');

    // Reset view
    container.innerHTML = '';
    spinner.style.display = 'block';
    tableWrapper.style.display = 'none';
    noCoursesMsg.style.display = 'none';

    // Fetch request
    fetch(`/courses-list?search=${encodeURIComponent(searchTerm)}`)
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(courses => {
        spinner.style.display = 'none';

        if (courses.length === 0) {
          noCoursesMsg.style.display = 'block';
          return;
        }

        tableWrapper.style.display = 'block'; // Show table

        // Render courses
        courses.forEach(course => {
          const courseRow = document.createElement('tr');
          courseRow.innerHTML = `
            <td>
              <a class="fw-semibold hover-underline text-reset" href="/courses/${course.id}">
                ${course.title}
              </a>
            </td>
            <td>
              ${course.course_progress == null ?`
              <form action="/courses/${course.id}/join" method="post">
                <button type="submit" class="action-btn bg-primary">
                  Join Course
                </button>
              </form>` : '<span class="fw-semibold bg-success text-white px-2 py-1 rounded">Enrolled</span>'}
            </td>
          `;
          container.appendChild(courseRow);
        });
      })
      .catch(error => {
        spinner.style.display = 'none';
        tableWrapper.style.display = 'none';
        container.innerHTML = '';
        noCoursesMsg.style.display = 'block';
        noCoursesMsg.textContent = 'Error loading courses. Please try again later.';
        console.error('Error fetching courses:', error);
      });
  }
</script>

<%- include('partials/_footer') %>
