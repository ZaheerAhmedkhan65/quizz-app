<%- include('partials/_header') %>
    
        <div class="col-lg-3">
                <div class="d-flex align-items-center justify-content-between">
                    <h1 style="width: 65%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" class="m-0 p-0"><%= quizz.title %></h1>
                    <% if (quizData.length > 0 && quizResults.length < 5) { %>
                        <a class="btn btn-sm btn-success my-3" href="/api/courses/<%= course.id %>/quizzes/<%= quizz.id %>/take">
                            <%= quizResults.length > 0 ? 'Retake Quiz' : 'Take Quiz' %>
                        </a>
                    <% } %>                    
                </div>
                <div class="progress-bar-container mb-2">
                    <div class="progress-bar-fill" data-progress="<%= quizz.quizz_progress %>"></div>
                </div>
                <form action="/api/courses/<%= course.id %>/quizzes/<%= quizz.id %>/questions" method="post" class="d-flex align-items-center gap-1">
                    <input type="text" id="question-text" name="question_text" class="form-control" placeholder="Enter Question text" required>
                    <button type="submit" id="createBtn" class="btn btn-sm btn-primary">Create</button>
                </form>
        </div>
        <%if(quizData.length > 0){%>
        <div class="col-lg-6" style="height: 90vh; overflow: hidden;">
            <h1 class="m-0 p-0 mb-3">Questions</h1>
            <% if(quizData.length > 0) { %>
            <ul id="questions-container" class="list-group overflow-auto rounded-0" style="height: 100%; padding-bottom: 80px;">
                <% quizData.forEach((question, index) => { %>
                    <li class="list-group-item bg-primary-subtle rounded-0 mb-2">
                        <div id="question_<%= question.id %>" class="border border-1 border-dark p-3 d-flex align-items-center justify-content-between">
                            <strong  data-text = "question-text" ><%=index+1%> : <%= question.question_text %></strong>
                            <!-- <div class="btn-group dropup">
                                <button type="button" class="bg-transparent border-0" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu">
                                  <li class="dropdown-item" data-id="<%= question.id %>">edit</li>
                                </ul>
                            </div> -->
                        </div>
                        <h5 class="mt-3">Options</h5>
                        <ul class="list-group">
                            <% question.options.forEach(option => { %>
                                <li class="list-group-item rounded-0 d-flex align-items-center gap-1">
                                    <!-- Ensure each question has its own radio group by using question.id -->
                                    <input type="radio" name="question_<%= question.id %>" 
                                           id="option_<%= option.id %>" 
                                           value="<%= option.option_text %>">
                                    <label for="option_<%= option.id %>"><%= option.option_text %> <%= option.is_correct ? '(Correct)' : '' %></label>
                                </li>
                            <% }) %>
                        </ul>
                        <% if (question.options.length <= 3) { %>
                        <!-- Form to create an option -->
                        <form action="/api/courses/<%= course.id %>/quizzes/<%= quizz.id %>/questions/<%= question.id %>/options" method="post">
                            <input type="text" name="option_text" class="form-control mt-3" placeholder="Enter Option text" required>
                            <select name="is_correct" class="form-select mt-3">
                                <option value="0">Incorrect</option>
                                <option value="1">Correct</option>
                            </select>
                            <div class="text-end mb-2">
                                <button type="submit" class="btn btn-sm btn-primary mt-3">Add Option</button>
                            </div>
                        </form>
                        <% } %>
                    </li>
                <% }) %>
            </ul>
            <% } else { %>
            <p>No questions have been created for this quiz.</p>
            <% } %>
        </div>
        <% if(quizResults.length > 0) {%>
            <div class="col-lg-3">
                <h1 class="m-0 p-0">Quiz Results</h1>
                <table id="results-table" class="table m-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="py-0">Total Marks</th>
                            <th class="py-0">Obtained Marks</th>
                            <th class="py-0">Percentage (%)</th>
                        </tr>
                    </thead>
                    <tbody class="table-group-divider">
                        <% quizResults.forEach((result) => { %>
                            <tr>
                                <td class="py-0"><%= result.total_marks %></td>
                                <td class="py-0"><%= result.score %></td>
                                <td class="py-0"><%= ((result.score / result.total_marks) * 100).toFixed(2) %></td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            
                <h3 class="m-0">Results :</h3>
                <ul id="results-container" class="list-group">
                    <% quizResults.forEach((result, attemptIndex) => { %>
                        <h5 class="mt-3">Attempt <%= attemptIndex + 1 %></h5>
                        <% Object.entries(result.answers).forEach(([questionId, answerId], index) => { 
                            const questionObj = questions.find(q => q.id == questionId);
                            const answerObj = answers.find(a => a.id == answerId);
                        %>
                            <li class="list-group-item bg-transparent">
                                <strong>#<%= index + 1 %> : <%= questionObj ? questionObj.question_text : "Question not found" %></strong><br>
            
                                <% if (answerObj) { %>
                                    <strong>Answer:</strong> 
                                    <span class="<%= answerObj.is_correct ? 'text-success' : 'text-danger' %>">
                                        <%= answerObj.option_text %>
                                    </span>
                                <% } else { %>
                                    <strong>Selected Answer:</strong> Not Answered
                                <% } %>
                            </li>
                            <hr>
                        <% }); %>
                    <% }); %>
                </ul>
            </div>
        <%}%>
       <%}else{%>
        <div class="col-lg-9">
            <div class="row mt-3">
                <div class="col-lg-8">
                    <h4>Quizz Question Creation Video</h4>
                    <div class="card rounded-0">
                            <video src="/videos/question creation video.mp4" controls autoplay="true" loop class="mt-2" style="width: 100%; height: auto;"></video>
                    </div>
                    <p class="mt-2">Watch the video to learn how to create a quizz question and options for it.  </p>
                </div>
                <div class="col-lg-4">
            
                </div>
            </div>      
        </div>
        <%}%>
        

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                let questionsContainer = document.getElementById("questions-container");
                questionsContainer.scrollTop = questionsContainer.scrollHeight;

                let resultsContainer = document.getElementById("results-container");
                let resultsTable = document.getElementById("results-table");

                resultsContainer.style.height = `calc(80vh - ${resultsTable.offsetHeight}px)`;
                });
        </script>
        <script src="/js/courseProgressBar.js"></script>
        <script src="/js/notifications.js"></script>
        <script src="/js/checkForDuplicate.js"></script>
        <script type="application/json" id="quizz-data">
            <%- JSON.stringify(quizData) %>
        </script>
    
        <script>
            let quizData = JSON.parse(document.getElementById("quizz-data").textContent);;
            
            document.addEventListener('DOMContentLoaded', () => {
                checkForDuplicate(quizData, document.getElementById('question-text'), "question text", 'question_text', document.getElementById('createBtn'), "Question");
            
                document.querySelectorAll('form[action*="/options"]').forEach(form => {
                    let optionInput = form.querySelector('input[name="option_text"]');
                    let submitButton = form.querySelector('button[type="submit"]');
                    
                    if (optionInput) {
                        optionInput.addEventListener('input', () => {
                            const questionId = form.action.split('/').slice(-2, -1)[0]; // Extract question ID
                            const question = quizData.find(q => q.id == questionId);
                            
                            if (question) {
                                checkForDuplicate(question.options, optionInput, "option text" ,'option_text', submitButton, "Option");
                            }
                        });
                    }
                });
            });
        </script>
        <script>
            // document.querySelectorAll('.dropdown-item[data-id]').forEach(editBtn => {
            //     editBtn.addEventListener('click', () => {
            //         let id = editBtn.getAttribute('data-id');
            //         let questionContainer = document.getElementById(`question_${id}`);
            //         let questionText = questionContainer.querySelector('strong[data-text="question-text"]');

            //         console.log(questionContainer)
            //         questionContainer.innerHTML = `
            //         <form action="/api/courses/<%= course.id %>/quizzes/<%= quizz.id %>/questions/${id}" method="post" class="d-flex flex-column w-100">
            //     <div class="d-flex align-items-center gap-1 justify-content-between w-100">
            //         <input type="hidden" name="question_id" value="${id}">
            //         <input type="text" name="question_text" value="${questionText.textContent}" class="form-control" placeholder="Enter course title" required id="editTitle">
            //         <button type="submit" class="btn btn-sm btn-primary">Update</button>
            //         <button type="button" class="btn btn-sm btn-danger" id="cancelBtn_${id}"><i class="bi bi-x-lg"></i></button>
            //     </div>
            //     <div id="error-message" class="text-danger mt-1 error-message"></div>
            // </form>
            //         `
            //     });
            // });
        </script>
    <%- include('partials/_footer') %>