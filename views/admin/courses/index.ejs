<%- include('../partials/_header') %>

<div class="row ">
    <div class="col-12">
        <h4 class="fw-bold mb-3">Courses</h4>
        <div id="loadingSpinner" class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only"></span>
            </div>
        </div>
        <div id="coursesContainer" class="row">
            <!-- Courses will be loaded here dynamically -->
        </div>
        <div id="noCoursesMessage" class="alert alert-warning text-center" style="display: none;">
            No courses found matching your criteria.
        </div>
    </div>
</div>
<script>
    const token = "<%= token %>";
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch courses data
        fetchCourses();
    });

    function fetchCourses(searchTerm = '') {
        const container = document.getElementById('coursesContainer');
        const spinner = document.getElementById('loadingSpinner');
        const noCoursesMsg = document.getElementById('noCoursesMessage');
        
        // Show loading spinner
        container.innerHTML = '';
        spinner.style.display = 'block';
        noCoursesMsg.style.display = 'none';
        
        // Make AJAX request
        fetch(`/courses-list?search=${encodeURIComponent(searchTerm)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(courses => {
                spinner.style.display = 'none';
                
                if (courses.length === 0) {
                    noCoursesMsg.style.display = 'block';
                    return;
                }
                
                // Render courses
                courses.forEach(course => {
                    const courseCol = document.createElement('div');
                    courseCol.className = 'col-lg-4 col-md-6 col-sm-12 mb-4';
                    
                    courseCol.innerHTML = `
                        <div class="card h-100">
                            <a href="/courses/${course.id}" class="text-decoration-none text-restart">
                                <div class="card-body">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <h5 class="card-title m-0">${course.title}</h5>
                                        <a href="#" id="course-${course.id}-dropdown"
                                            data-bs-toggle="dropdown" aria-expanded="true" class="">
                                            <i class="mdi mdi-dots-vertical"></i>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-end"
                                            aria-labelledby="course-${course.id}-dropdown">
                                            <a href="/admin/courses/${course.id}/edit" class="dropdown-item"><i class="mdi mdi-pencil"></i> Edit</a>
                                            <form class="delete-course-form" data-course-id="${course.id}" action="https://pdf-files-production.up.railway.app/admin/courses/${course.id}/delete" onsubmit="return confirm('Are you sure you want to delete this course?')" method="post">
                                                <button type="submit" class="dropdown-item"><i class="mdi mdi-trash-can"></i> Delete</button>
                                            </form>
                                            ${course.handout_pdf ? `<a href="${course.handout_pdf}" class="dropdown-item" download><i class="mdi mdi-download"></i> Download PDF</a>` : ''}
                                        </div>
                                    </div>
                                    <p class="card-text text-muted">Click to view course details</p>
                                </div>
                            </a>
                        </div>
                    `;
                    
                    container.appendChild(courseCol);
                });
            })
            .catch(error => {
                spinner.style.display = 'none';
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">Error loading courses. Please try again later.</div>
                    </div>
                `;
                console.error('Error fetching courses:', error);
            });
    }
</script>

<%- include('../partials/_footer') %>