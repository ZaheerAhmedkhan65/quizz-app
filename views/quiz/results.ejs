<%- include('../partials/_header') %>
<div class="container">
    <h1>Quiz Results</h1>
    
    <div class="summary mb-4">
        <h2>Summary</h2>
        <p>Score: <%= attempt.score %>%</p>
        <p>Correct Answers: <%= attempt.correct_answers %> / <%= attempt.total_questions %></p>
        <p>Date: <%= attempt.created_at %></p>
    </div>

    <!-- Progress Chart -->
    <div class="mb-5">
        <h2>Your Progress in this Lecture</h2>
        <canvas id="lectureChart" height="150"></canvas>
    </div>

    <div class="detailed-results">
        <h2>Detailed Results</h2>

        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Question</th>
                    <th>Your Answer</th>
                    <th>Result</th>
                    <th>Correct Answer</th>
                </tr>
            </thead>
            <tbody>
                <% responses.forEach((response, index) => { %>
                    <tr class="<%= response.is_correct ? 'table-success' : 'table-danger' %>">
                        <td><%= index + 1 %></td>
                        <td><%= response.question_text %></td>
                        <td><%= response.user_option_text || 'No answer' %></td>
                        <td><%= response.is_correct ? '✓ Correct' : '✗ Incorrect' %></td>
                        <td>
                            <% if (!response.is_correct) { %>
                                <%= response.correct_option_text %>
                            <% } else { %>
                                -
                            <% } %>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>

    <a href="/courses/<%= course_id %><%= lecture_id ? '/' + lecture_id : '' %>" class="btn btn-primary">
        Back to <%= lecture_id ? 'Lecture' : 'Course' %>
    </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const lectureAttempts = <%- JSON.stringify(lectureAttempts) %>;

    if (lectureAttempts.length > 0) {
        const labels = lectureAttempts.map(a => new Date(a.created_at).toLocaleDateString());
        const scores = lectureAttempts.map(a => Math.round(a.score));
        const correct = lectureAttempts.map(a => a.correct_answers);
        const totals = lectureAttempts.map(a => a.total_questions);

        const ctx = document.getElementById('lectureChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Score (%)',
                        data: scores,
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0,0,255,0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Correct Answers',
                        data: correct,
                        borderColor: 'green',
                        backgroundColor: 'rgba(0,255,0,0.1)',
                        tension: 0.3,
                        fill: false
                    },
                    {
                        label: 'Total Questions',
                        data: totals,
                        borderColor: 'gray',
                        backgroundColor: 'rgba(200,200,200,0.1)',
                        borderDash: [5, 5],
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: true, text: 'Progress Over Attempts' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
</script>

<%- include('../partials/_footer') %>
