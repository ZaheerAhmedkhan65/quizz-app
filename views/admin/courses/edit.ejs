<%- include('../partials/_header') %>
<div class="row">
    <div class="col-12">
        <div class="card rounded-0 min-vh-100">
            <div class="card-body">
                <h4 class="card-title">Edit Course</h4>
                <form id="edit-course-form" action="/admin/courses/<%= course.id %>/update" method="post" enctype="multipart/form-data">
                    <div class="form-group mb-4">
                        <label for="title" class="form-label">Course Title</label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="<%= course.title %>" placeholder="Enter course title" required>
                        <div class="form-text">Keep it short and descriptive</div>
                    </div>
                    <div class="form-group mb-4">
                        <label for="slug">Slug</label>
                        <input type="text" class="form-control" id="slug" name="slug" 
                               value="<%= course.slug %>" required>
                    </div>
                    <div class="form-group mb-4">
                        <label for="handout_pdf" class="form-label">Upload PDF</label>
                        <div class="card border-2 border-dashed rounded-2" id="dropzone">
                            <div class="card-body text-center d-flex flex-column justify-content-center align-items-center" style="min-height: 150px;">
                                <i class="bi bi-file-earmark-pdf fs-1 text-muted mb-2"></i>
                                <h5 class="mb-2">Drag & drop your PDF here</h5>
                                <p class="text-muted mb-3">or</p>
                                <input type="file" class="form-control-file d-none" id="handout_pdf" name="handout_pdf" accept=".pdf">
                                <button type="button" class="btn btn-outline-primary" id="browseBtn">
                                    <i class="mdi mdi-file-outline me-2"></i>Browse Files
                                </button>
                                <p class="small text-muted mt-2 mb-0">Supports: PDF only (Max: 100MB)</p>
                                <p class="text-muted mb-3">or</p>
                                <div class="form-group">
                                    <label for="pdfUrl" class="form-label">PDF URL</label>
                                    <input type="text" class="form-control" id="pdfUrl" name="pdfUrl" value="<%= course.handout_pdf %>" placeholder="Enter PDF URL">
                                </div>
                                 <div class="form-group">
                                    <label for="handout_original_filename" class="form-label">PDF Original Name</label>
                                    <input type="text" class="form-control" id="handout_original_filename" name="handout_original_filename" value="<%= course.handout_original_filename %>" placeholder="Enter PDF Original Name">
                                </div>
                                
                                <!-- Show existing file if available -->
                                <% if (course.handout_pdf) { %>
                                    <div id="fileInfo" class="mt-3 position-relative">
                                        <span class="badge bg-success">
                                            <i class="mdi mdi-file me-1"></i>
                                            <a href="https://drive.google.com/file/d/<%= course.handout_pdf %>/view?usp=drive_link" target="_blank" class="text-white text-decoration-none">
                                                <%= course.handout_original_filename %>
                                            </a>
                                        </span>
                                        <button type="button" class="btn btn-sm btn-danger rounded-circle position-absolute" 
                                                style="top: -15px; right: -15px; padding: 2px 4px;" id="removeFile">
                                            <i class="mdi mdi-close"></i>
                                        </button>
                                    </div>
                                <% } else { %>
                                    <div id="fileInfo" class="mt-3 d-none position-relative">
                                        <span class="badge bg-success">
                                            <i class="mdi mdi-file me-1"></i>
                                            <span id="fileName"></span>
                                        </span>
                                        <button type="button" class="btn btn-sm btn-danger rounded-circle position-absolute" 
                                                style="top: -15px; right: -15px; padding: 2px 4px;" id="removeFile">
                                            <i class="mdi mdi-close"></i>
                                        </button>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 mb-4">
                        <button type="submit" class="btn btn-primary">
                           Update
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('handout_pdf');
        const browseBtn = document.getElementById('browseBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const removeFile = document.getElementById('removeFile');
        const titleInput = document.getElementById('title');
        const slugInput = document.getElementById('slug');
        
        // Slug generation (same as new course)
        titleInput.addEventListener('input', function() {
            const title = titleInput.value;
            let slug = title;
            const romanNumerals = ['I','II','III','IV','V','VI','VII','VIII','IX','X'];
            romanNumerals.forEach(num => {
                const regex = new RegExp(`\\b${num}\\b`, 'g');
                slug = slug.replace(regex, `ROMAN_${num}_ROMAN`);
            });
            slug = slug.toLowerCase()
                       .replace(/\s+/g, '-')
                       .replace(/[^a-z0-9-]/g, '')
                       .replace(/-+/g, '-')
                       .replace(/^-+|-+$/g, '');
            romanNumerals.forEach(num => {
                const lowerNum = num.toLowerCase();
                slug = slug.replace(`roman_${lowerNum}_roman`, num);
            });
            slugInput.value = slug;
        });
        
        // Drag events
        ['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, highlight,false));
        ['dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, unhighlight,false));
        function highlight(e){ e.preventDefault(); dropzone.classList.add('border-primary','bg-light'); }
        function unhighlight(e){ e.preventDefault(); dropzone.classList.remove('border-primary','bg-light'); }
        
        // Drop file
        dropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            if (e.dataTransfer.files.length) {
                const file = e.dataTransfer.files[0];
                if (file.type === 'application/pdf') {
                    fileInput.files = e.dataTransfer.files;
                    updateFileInfo(file.name);
                } else alert('Please upload a PDF file only.');
            }
        });
        
        // Browse
        browseBtn.addEventListener('click', () => fileInput.click());
        
        // Change input
        fileInput.addEventListener('change', function() {
            if (fileInput.files.length) {
                const file = fileInput.files[0];
                if (file.type === 'application/pdf') updateFileInfo(file.name);
                else { alert('Please upload a PDF file only.'); fileInput.value=''; }
            }
        });
        
        // Remove file
        if (removeFile) {
            removeFile.addEventListener('click', function() {
                fileInput.value = '';
                fileInfo.classList.add('d-none');
            });
        }
        
        function updateFileInfo(name){
            if(fileName){ fileName.textContent = name; }
            fileInfo.classList.remove('d-none');
        }
    });
</script>

<style>
    #dropzone { transition: all 0.3s ease; cursor: pointer; }
    #dropzone:hover { border-color:#0d6efd !important; background-color:rgba(13,110,253,0.05) !important; }
</style>

<script>
    
        const token = "<%= token %>";

        const editCourseForm = document.getElementById('edit-course-form');
        editCourseForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            // collect all form data
            const formData = new FormData(editCourseForm);
            console.log("formData: ", formData);
            try {
                const response = await fetch(editCourseForm.action, {
                    method: editCourseForm.method,
                    headers: {
                        "Authorization": `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.statusText}`);
                }

                const result = await response.json();
                setTimeout(() => {
                    window.location.href = '/admin/courses/'+result.course.id;
                }, 1000);
                // optionally show success message or redirect
            } catch (err) {
                setTimeout(() => {
                    window.location.href = '/admin/courses/'+result.course.id;
                }, 1000);
                console.error("Failed to create course:", err);
            }
        });
</script>

<%- include('../partials/_footer') %>
